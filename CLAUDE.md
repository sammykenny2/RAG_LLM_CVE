# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Git Policy

**CRITICAL: Never commit or push code changes to the git repository unless explicitly requested by the user.**

## Project Overview

RAG-based CVE validation system for security operations centers (SOCs). Validates CVE usage in threat intelligence reports using Meta's Llama 3.2-1B-Instruct model combined with retrieval-augmented generation to reduce LLM hallucinations.

## Prerequisites

- Python 3.10
- CUDA-capable GPU recommended (CPU fallback available)
- Hugging Face account with Llama model access approval
- Run `huggingface-cli login` before first use
- External CVE JSON feeds in `../cvelist/2024` (v4 schema) and `../cvelistV5/cves/2024` (v5 schema)

## Installation

```bash
pip install -r requirements.txt
```

## Workflow

### 1. Build Embedding Database
Run `localEmbedding4.py` to create the retrieval corpus from curated analyst reports:
```bash
python localEmbedding4.py
```
- Prompts for input PDF path (e.g., `CVEpdf2024.pdf`)
- Tokenizes with spaCy sentencizer into 10-sentence chunks
- Encodes with `all-mpnet-base-v2` SentenceTransformer
- Outputs CSV (e.g., `test6.csv`) containing embeddings + text chunks
- **Critical**: `theRag.py` requires this CSV for retrieval context

### 2. (Optional) Generate Human-Readable CVE Reference
Convert MITRE/NVD JSON feeds to flat text for manual browsing:
```bash
python extractCVE.py  # Auto-detects v5/v4 schema in ../cvelist/2024
```
- Creates `CVEDescription2024.txt`
- Does **not** affect RAG retrieval; purely for reference

### 3. Run CVE Validation
Main RAG application with dual-mode support:
```bash
python theRag.py             # Full mode (default): complete features
python theRag.py --mode=demo # Demo mode: memory-optimized
python theRag.py --mode=full # Full mode: explicit
```

**Demo Mode (--mode=demo)**:
- Processes only first 10 pages of PDF
- Limits text to 1000-2000 characters
- Reads only first 1000 rows from embedding CSV
- Returns top-3 retrieval results
- Token generation: 64-256 tokens
- FP16 precision + CUDNN optimizations

**Full Mode (default)**:
- Processes entire PDF with intelligent chunking
- 1500-token chunks with 200-token overlap
- Reads complete embedding CSV
- Returns top-5 retrieval results
- Token generation: 150-700 tokens
- Context extraction for missing CVEs (up to 2000 chars)

**Interactive menu** (both modes):
  1. Summarize report
  2. Validate CVE usage (compares report context vs. official descriptions)
  3. Custom Q&A about report
  4. Exit

## Architecture Details

### CVE Extraction (Optimized)
- **Direct regex pattern matching** on PDF text: `CVE-\d{4}-\d{4,7}`
- No LLM involvement in extraction (fast and accurate)
- Legacy LLM-based extraction preserved in code for reference

### CVE Lookup Strategy
1. **JSON File Lookup with v5→v4 fallback**:
   - Primary: `../cvelistV5/cves/<year>/<prefix>/CVE-<year>-<id>.json` (v5 schema)
   - Fallback: `../cvelist/<year>/<prefix>/CVE-<year>-<id>.json` (v4 schema)
   - Auto-detects schema and extracts: `cveId`, `vendor`, `product`, `description`
2. **Fallback for Missing CVEs**:
   - Demo mode: Uses first 500 chars of report
   - Full mode: Extracts context window around CVE (up to 2000 chars)
   - Asks Llama to paraphrase usage in 2 sentences
   - Retrieves similar CVEs using `asking_llama_for_advice()`

### Embedding & Retrieval (Optimized)
- **Global SentenceTransformer**: Loaded once at startup (not per-call)
- Model: `all-mpnet-base-v2` (768 dimensions)
- Loads `test6.csv` with precomputed embeddings
- Returns top-3 (demo) or top-5 (full) chunks via dot product scoring
- Feeds retrieved context + query to Llama for CVE recommendation

### Memory Management
- **All inference calls use `torch.no_grad()`** for efficiency
- **CUDA cache cleared** after each chunk in full mode
- **Periodic GC** during PDF processing in demo mode
- **Context length limits** prevent OOM errors
- Auto-detects CUDA/CPU, works offline after first run

## File Paths & Dependencies

### Expected Directory Structure
```
RAG_LLM_CVE/
├── theRag.py           # Main RAG application (dual-mode)
├── localEmbedding.py   # Generate embedding database
├── extractCVE.py       # Optional: export CVE descriptions
├── test6.csv           # Generated by localEmbedding.py
├── test_data/          # Temporary test files (gitignored)
└── cleanupLlamaCache.py # Clean Llama model cache
../
├── cvelist/
│   └── 2024/           # v4 CVE JSON feeds (fallback)
└── cvelistV5/
    └── cves/
        └── 2024/       # v5 CVE JSON feeds (primary)
```

### Key File Interactions
- `theRag.py` reads from:
  - User-provided PDF (via `fitz.open`)
  - `test6.csv` (embedding database)
  - `../cvelistV5/cves/<year>/<prefix>/CVE-*.json` (primary)
  - `../cvelist/<year>/<prefix>/CVE-*.json` (fallback)
- `localEmbedding.py` writes to:
  - User-specified CSV output path
- `extractCVE.py` writes to:
  - `CVEDescription2024.txt`

## Model Configuration

### Llama 3.2-1B-Instruct Settings
- **Device**: Auto-detects CUDA/CPU (`device_map="auto"`)
- **Model initialization**:
  - Demo mode: `torch_dtype=torch.float16`, `low_cpu_mem_usage=True`
  - Full mode: `torch_dtype="auto"`
- **Generation params**:
  - `temperature=0.3`, `top_p=0.9`, `do_sample=True`
  - `pad_token_id=tokenizer.eos_token_id` (all calls)
- **Token limits**:
  - Demo mode: 64-256 tokens
  - Full mode: 150-700 tokens
- **Memory management**:
  - All inference wrapped in `torch.no_grad()`
  - Demo mode: CUDNN deterministic mode enabled
  - `cleanup_model()` on exit
- **Offline capable**: Models cached in `~/.cache/huggingface/hub/`
  - First run: ~2.9 GB download (Llama + mpnet)
  - Subsequent runs: fully offline

### Embedding Model
- `all-mpnet-base-v2` from SentenceTransformers
- 768-dimensional embeddings
- **Globally initialized once** at startup (performance optimization)
- Used for both corpus building (`localEmbedding.py`) and query encoding (`theRag.py`)

## Important Notes

- **Sync CVE Feeds**: Ensure `../cvelistV5/` and `../cvelist/` are up-to-date to minimize "Could Not Find" fallbacks
- **CSV Dependency**: `test6.csv` must exist before running `theRag.py`; generate with `localEmbedding.py`
- **CVE Path Format**: Second set of CVE ID formatted as `Nxxx` (e.g., `4` → `0xxx`, `12345` → `12xxx`) via `format_second_set()`
- **Network Requirements**: First run downloads ~2.9 GB; subsequent runs fully offline
- **Memory Requirements**:
  - Demo mode: ~4 GB RAM minimum
  - Full mode: ~8 GB RAM recommended (CPU) or ~4 GB VRAM (GPU)
